<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2487.2">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Helvetica Neue'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Helvetica Neue'; min-height: 15.0px}
  </style>
</head>
<body>
<p class="p1">// このファイルは、Vercelのサーバーレス関数として動作します。</p>
<p class="p1">const { VertexAI } = require("@google-cloud/vertexai");</p>
<p class="p2"><br></p>
<p class="p1">export default async function handler(req, res) {</p>
<p class="p1"><span class="Apple-converted-space">  </span>// CORSヘッダーを設定</p>
<p class="p1"><span class="Apple-converted-space">  </span>res.setHeader('Access-Control-Allow-Origin', '*');</p>
<p class="p1"><span class="Apple-converted-space">  </span>res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');</p>
<p class="p1"><span class="Apple-converted-space">  </span>res.setHeader('Access-Control-Allow-Headers', 'Content-Type');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>if (req.method === "OPTIONS") { return res.status(204).send(""); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if (req.method !== "POST") { return res.status(405).json({ error: "Method Not Allowed" }); }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>try {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const { feature, prompt, image, isMobile } = req.body;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!process.env.GCP_PROJECT_ID || !process.env.GCP_CLIENT_EMAIL || !process.env.GCP_PRIVATE_KEY) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>throw new Error("GCP認証情報が環境変数に設定されていません。");</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>const vertexAI = new VertexAI({</p>
<p class="p1"><span class="Apple-converted-space">        </span>project: process.env.GCP_PROJECT_ID,</p>
<p class="p1"><span class="Apple-converted-space">        </span>location: "asia-northeast1",</p>
<p class="p1"><span class="Apple-converted-space">        </span>credentials: {</p>
<p class="p1"><span class="Apple-converted-space">            </span>client_email: process.env.GCP_CLIENT_EMAIL,</p>
<p class="p1"><span class="Apple-converted-space">            </span>private_key: process.env.GCP_PRIVATE_KEY.replace(/\\n/g, '\n'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>let responsePayload;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (feature === "analyzer" &amp;&amp; image) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>const model = "gemini-2.5-flash-preview-05-20";</p>
<p class="p1"><span class="Apple-converted-space">      </span>const generativeModel = vertexAI.getGenerativeModel({ model });</p>
<p class="p1"><span class="Apple-converted-space">      </span>const request = {</p>
<p class="p1"><span class="Apple-converted-space">        </span>contents: [{ role: "user", parts: [</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "あなたはプロのファッション評論家です。アップロードされた画像に写っている人物の服装を詳細に分析し、良い点、改善点、おすすめアイテムを提案してください。フレンドリーかつ具体的なアドバイスを日本語でお願いします。" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ inlineData: { mimeType: image.mimeType, data: image.data } },</p>
<p class="p1"><span class="Apple-converted-space">        </span>]}]};</p>
<p class="p1"><span class="Apple-converted-space">      </span>const result = await generativeModel.generateContent(request);</p>
<p class="p1"><span class="Apple-converted-space">      </span>responsePayload = result.response.candidates[0].content.parts[0];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>} else if (feature === "generator") {</p>
<p class="p1"><span class="Apple-converted-space">      </span>const modelName = isMobile ? "gemini-2.5-flash-image-preview" : "imagen-3.0-generate-002";</p>
<p class="p1"><span class="Apple-converted-space">      </span>let generatedText = "AIによるコーディネート提案です。";</p>
<p class="p1"><span class="Apple-converted-space">      </span>let generatedImageBase64 = null;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>if (modelName === "imagen-3.0-generate-002") {</p>
<p class="p1"><span class="Apple-converted-space">        </span>let imagePrompt = prompt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(image) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const textGenModel = vertexAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-05-20" });</p>
<p class="p1"><span class="Apple-converted-space">            </span>const textGenRequest = { contents: [{ role: "user", parts: [ { text: `以下の指示と画像から、服装の特徴を具体的に描写した画像生成用のプロンプトを作成してください。服装の描写のみを出力してください。\n\n指示: ${prompt}`}, { inlineData: { mimeType: image.mimeType, data: image.data } } ]}]};</p>
<p class="p1"><span class="Apple-converted-space">            </span>const textResult = await textGenModel.generateContent(textGenRequest);</p>
<p class="p1"><span class="Apple-converted-space">            </span>generatedText = `元の指示「${prompt}」に基づいた提案です。`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>imagePrompt = textResult.response.candidates[0].content.parts[0].text;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>const imageGenModel = vertexAI.getGenerativeModel({ model: "imagen-3.0-generate-002" });</p>
<p class="p1"><span class="Apple-converted-space">        </span>const imageResult = await imageGenModel.generateContent(imagePrompt);</p>
<p class="p1"><span class="Apple-converted-space">        </span>generatedImageBase64 = imageResult.response.candidates[0].content.parts.find(p =&gt; p.fileData)?.fileData.data;</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>const generativeModel = vertexAI.getGenerativeModel({ model: "gemini-2.5-flash-image-preview" });</p>
<p class="p1"><span class="Apple-converted-space">        </span>const parts = [{ text: prompt }];</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (image) { parts.push({ inlineData: { mimeType: image.mimeType, data: image.data } }); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>const request = { contents: [{ role: "user", parts }] };</p>
<p class="p1"><span class="Apple-converted-space">        </span>const result = await generativeModel.generateContent(request);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const content = result.response.candidates[0].content;</p>
<p class="p1"><span class="Apple-converted-space">        </span>generatedText = content.parts.find(p =&gt; p.text)?.text;</p>
<p class="p1"><span class="Apple-converted-space">        </span>generatedImageBase64 = content.parts.find(p =&gt; p.inlineData)?.inlineData.data;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>responsePayload = { text: generatedText, base64Data: generatedImageBase64 };</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">      </span>throw new Error("無効なリクエストです。");</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>return res.status(200).json(responsePayload);</p>
<p class="p1"><span class="Apple-converted-space">  </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.error("サーバーエラー:", error);</p>
<p class="p1"><span class="Apple-converted-space">    </span>return res.status(500).json({ error: error.message || "サーバー内部でエラーが発生しました。" });</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1">}</p>
<p class="p2"><br></p>
</body>
</html>
